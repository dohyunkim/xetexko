% xetexko-font.sty
%
% Copyright (c) 2013-2020 Dohyun Kim  <nomos at ktug org>
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3c
% of this license or (at your option) any later version.
% The latest version of this license is in
%  http://www.latex-project.org/lppl.txt
% and version 1.3c or later is part of all distributions of LaTeX
% version 2006/05/20 or later.

\ProvidesPackage{xetexko-font}[2020/02/17 v2.23 LaTeX Font commands for XeTeX-ko]

\RequirePackage{fontspec}[2020/02/03]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% for old hangul rendering
\newfontfeature{YetHangul}{script=hang}

\ExplSyntaxOn
%%%%%%%%%%%%%%%%%%%%%
% hangul font options
\tl_new:N \l_xtxko_font_opts_tl
\tl_new:N \l_xtxko_font_opts_init_tl
\tl_new:N \l_xtxko_hangul_font_opts_init_tl
\tl_new:N \l_xtxko_hanja_font_opts_init_tl
\tl_new:N \l_xtxko_rem_tl
\int_const:Nn \c__xtxko_one_int { 1 }
\int_const:Nn \c__xtxko_two_int { 2 }
\tl_set:Nn \l_xtxko_font_opts_init_tl
  {
    \cs_set_eq:NN \xetexkointerhchar          \c_empty_tl
    \cs_set_eq:NN \xetexkolowerexclamation    \c_empty_tl
    \cs_set_eq:NN \xetexkolowerperiod         \c_empty_tl
    \cs_set_eq:NN \xetexkolowercomma          \c_empty_tl
    \cs_set_eq:NN \xetexkolowerquestion       \c_empty_tl
    \cs_set_eq:NN \xetexkopostexclamationkern \c_empty_tl
    \cs_set_eq:NN \xetexkopostperiodkern      \c_empty_tl
    \cs_set_eq:NN \xetexkopostcommakern       \c_empty_tl
    \cs_set_eq:NN \xetexkopostquestionkern    \c_empty_tl
    \cs_set_eq:NN \xetexkopreexclamationkern  \c_empty_tl
    \cs_set_eq:NN \xetexkopreperiodkern       \c_empty_tl
    \cs_set_eq:NN \xetexkoprecommakern        \c_empty_tl
    \cs_set_eq:NN \xetexkoprequestionkern     \c_empty_tl
    \cs_set_eq:NN \xetexkoquoteraise          \c_empty_tl
    \cs_set_eq:NN \xetexkoquotewidth          \c_empty_tl
    \cs_set_eq:NN \xetexkocharraise           \c_empty_tl
    \cs_set_nopar:Npn \xetexkohu              {0.05em}
    \cs_set_nopar:Npn \xetexkopostmathskip    {\dim_eval:n {\xetexkohu*2}}
  }
\cs_new:Nn \__xtxko_add_font_opt:Nn
  {
    \tl_put_right:Nn \l_xtxko_font_opts_tl { \cs_set_nopar:Npn #1 {#2} }
  }
\keys_define:nn { xtxko-font }
  {
    hu .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkohu                  {#1} } ,
    interhchar .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkointerhchar          {#1} } ,
    lowerexclamation .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkolowerexclamation    {#1} } ,
    lowerperiod .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkolowerperiod         {#1} } ,
    lowercomma .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkolowercomma          {#1} } ,
    lowerquestion .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkolowerquestion       {#1} } ,
    postexclamationkern .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkopostexclamationkern {#1} } ,
    postmathskip .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkopostmathskip        {#1} } ,
    postperiodkern .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkopostperiodkern      {#1} } ,
    postcommakern .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkopostcommakern       {#1} } ,
    postquestionkern .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkopostquestionkern    {#1} } ,
    preexclamationkern .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkopreexclamationkern  {#1} } ,
    preperiodkern .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkopreperiodkern       {#1} } ,
    precommakern .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkoprecommakern        {#1} } ,
    prequestionkern .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkoprequestionkern     {#1} } ,
    quoteraise .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkoquoteraise          {#1} } ,
    quotewidth .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkoquotewidth          {#1} } ,
    charraise .code:n =
      { \__xtxko_add_font_opt:Nn \xetexkocharraise           {#1} } ,
    InterLatinCJK .meta:n = { hu          = {#1} } ,
    InterHangul   .meta:n = { interhchar  = {#1} } ,
    PunctRaise    .meta:n = { lowerperiod = { \dim_eval:n {-#1} } } ,
    CharRaise     .meta:n = { charraise   = {#1} } ,
  }
\tl_set_eq:NN \l_xtxko_hangul_font_opts_init_tl \l_xtxko_font_opts_init_tl
\cs_new:Nn \__xtxko_hangul_assign_font_opts:n
  {
    \tl_set_eq:NN \l_xtxko_font_opts_tl \l_xtxko_hangul_font_opts_init_tl
    \keys_set_known:nxN { xtxko-font } {#1} \l_xtxko_rem_tl
  }
\tl_set_eq:NN \l_xtxko_hanja_font_opts_init_tl  \l_xtxko_font_opts_init_tl
\cs_new:Nn \__xtxko_hanja_assign_font_opts:n
  {
    \tl_set_eq:NN \l_xtxko_font_opts_tl \l_xtxko_hanja_font_opts_init_tl
    \keys_set_known:nxN { xtxko-font } {#1} \l_xtxko_rem_tl
  }
\cs_new:Nn \__xtxko_def_XKhan__fonts:nnn
  {
    \cs_if_eq:NNF #1 \relax
      {
        \str_if_eq:eeT \familydefault #2
          {
            \cs_if_eq:NNTF \XKhangulfont #1
              {
                \cs_set_nopar:Npn #1
                  {
                    \XK@storeltnfont
                    \chardef\XKcurrentfont \c__xtxko_one_int #3
                    \XK@storecjkfont
                  }
              }
              {
                \cs_set_nopar:Npn #1
                  {
                    \XK@storeltnfont
                    \chardef\XKcurrentfont \c__xtxko_two_int #3
                    \XK@storecjkfont
                  }
              }
          }
      }
  }
% suppress bx font warnings
\cs_new_nopar:Npn \l_xetexko_pacify_bfseries {
  \cs_if_exist:cF
    { \g_fontspec_encoding_tl/\l_fontspec_family_tl/bx/\shapedefault }
    {
      \cs_set_eq:cc
        { \g_fontspec_encoding_tl/\l_fontspec_family_tl/bx/\shapedefault }
        { \g_fontspec_encoding_tl/\l_fontspec_family_tl/\bfdefault/\shapedefault }
    }
  \cs_if_exist:cF
    { \g_fontspec_encoding_tl/\l_fontspec_family_tl/bx/\itdefault }
    {
      \cs_set_eq:cc
        { \g_fontspec_encoding_tl/\l_fontspec_family_tl/bx/\itdefault }
        { \g_fontspec_encoding_tl/\l_fontspec_family_tl/\bfdefault/\itdefault }
    }
  \cs_if_exist:cF
    { \g_fontspec_encoding_tl/\l_fontspec_family_tl/bx/\sldefault }
    {
      \cs_set_eq:cc
        { \g_fontspec_encoding_tl/\l_fontspec_family_tl/bx/\sldefault }
        { \g_fontspec_encoding_tl/\l_fontspec_family_tl/\bfdefault/\sldefault }
    }
  \cs_if_exist:cF
    { \g_fontspec_encoding_tl/\l_fontspec_family_tl/\mddefault/\updefault }
    {
      \cs_set_eq:cc
        { \g_fontspec_encoding_tl/\l_fontspec_family_tl/\mddefault/\updefault }
        { \g_fontspec_encoding_tl/\l_fontspec_family_tl/\mddefault/\shapedefault }
    }
}
%%%%%%%%%%%%%%%%%%%%
% user font commands
\DeclareDocumentCommand \setmainhangulfont { O{} m O{} }
  {
    \__xtxko_hangul_assign_font_opts:n {#1,#3}
    \setfontfamily \kormainfont [\l_xtxko_rem_tl] {#2}
    \l_xetexko_pacify_bfseries
    \tl_put_right:NV \kormainfont \l_xtxko_font_opts_tl
    \__xtxko_def_XKhan__fonts:nnn \XKhangulfont \rmdefault \kormainfont
    \ignorespaces
  }
\DeclareDocumentCommand \setsanshangulfont { O{} m O{} }
  {
    \__xtxko_hangul_assign_font_opts:n {#1,#3}
    \setfontfamily \korsansfont [\l_xtxko_rem_tl] {#2}
    \l_xetexko_pacify_bfseries
    \tl_put_right:NV \korsansfont \l_xtxko_font_opts_tl
    \__xtxko_def_XKhan__fonts:nnn \XKhangulfont \sfdefault \korsansfont
    \ignorespaces
  }
\DeclareDocumentCommand \setmonohangulfont { O{} m O{} }
  {
    \setfontfamily \kormonofont [#1,#3] {#2}
    \l_xetexko_pacify_bfseries
    \__xtxko_def_XKhan__fonts:nnn \XKhangulfont \ttdefault \kormonofont
    \ignorespaces
  }
\DeclareDocumentCommand \setmainhanjafont { O{} m O{} }
  {
    \__xtxko_hanja_assign_font_opts:n {#1,#3}
    \setfontfamily \hnjmainfont [\l_xtxko_rem_tl] {#2}
    \l_xetexko_pacify_bfseries
    \tl_put_right:NV \hnjmainfont \l_xtxko_font_opts_tl
    \__xtxko_def_XKhan__fonts:nnn \XKhanjafont \rmdefault \hnjmainfont
    \ignorespaces
  }
\DeclareDocumentCommand \setsanshanjafont { O{} m O{} }
  {
    \__xtxko_hanja_assign_font_opts:n {#1,#3}
    \setfontfamily \hnjsansfont [\l_xtxko_rem_tl] {#2}
    \l_xetexko_pacify_bfseries
    \tl_put_right:NV \hnjsansfont \l_xtxko_font_opts_tl
    \__xtxko_def_XKhan__fonts:nnn \XKhanjafont \sfdefault \hnjsansfont
    \ignorespaces
  }
\DeclareDocumentCommand \setmonohanjafont { O{} m O{} }
  {
    \setfontfamily \hnjmonofont [#1,#3] {#2}
    \l_xetexko_pacify_bfseries
    \__xtxko_def_XKhan__fonts:nnn \XKhanjafont \ttdefault \hnjmonofont
    \ignorespaces
  }
%% {hangul,hanja}fontspec = adhoc{hangul,hanja}font
\DeclareDocumentCommand \adhochangulfont { O{} m O{} }
  {
    \__xtxko_hangul_assign_font_opts:n {#1,#3}
    \setfontfamily \XK@adhoc@hangul@font [\l_xtxko_rem_tl] {#2}
    \l_xetexko_pacify_bfseries
    \tl_put_right:NV \XK@adhoc@hangul@font \l_xtxko_font_opts_tl
    \cs_set_nopar:Npn \XKhangulfont
      {
        \XK@storeltnfont
        \cs_set_eq:NN \XKcurrentfont \c__xtxko_one_int
        \XK@adhoc@hangul@font
        \XK@storecjkfont
      }
    \ignorespaces
  }
\cs_set_eq:NN \hangulfontspec \adhochangulfont
\DeclareDocumentCommand \adhochanjafont { O{} m O{} }
  {
    \__xtxko_hanja_assign_font_opts:n {#1,#3}
    \setfontfamily \XK@adhoc@hanja@font [\l_xtxko_rem_tl] {#2}
    \l_xetexko_pacify_bfseries
    \tl_put_right:NV \XK@adhoc@hanja@font \l_xtxko_font_opts_tl
    \cs_set_nopar:Npn \XKhanjafont
      {
        \XK@storeltnfont
        \cs_set_eq:NN \XKcurrentfont \c__xtxko_two_int
        \XK@adhoc@hanja@font
        \XK@storecjkfont
      }
    \ignorespaces
  }
\cs_set_eq:NN \hanjafontspec \adhochanjafont
%% new{hangul,hanja}font{family,face}
\DeclareDocumentCommand \newhangulfontfamily { m O{} m O{} }
  {
    \__xtxko_hangul_assign_font_opts:n {#2,#4}
    \exp_args:Nc \setfontfamily { XK@newfont@family \token_to_str:N #1 } [\l_xtxko_rem_tl] {#3}
    \l_xetexko_pacify_bfseries
    \tl_put_right:cV { XK@newfont@family \token_to_str:N #1 } \l_xtxko_font_opts_tl
    \DeclareRobustCommand #1
      {
        \cs_set_nopar:Npn \XKhangulfont
          {
            \XK@storeltnfont
            \cs_set_eq:NN \XKcurrentfont \c__xtxko_one_int
            \use:c { XK@newfont@family \token_to_str:N #1 }
            \XK@storecjkfont
          }
      }
  }
\DeclareDocumentCommand \newhanjafontfamily { m O{} m O{} }
  {
    \__xtxko_hanja_assign_font_opts:n {#2,#4}
    \exp_args:Nc \setfontfamily { XK@newfont@family \token_to_str:N #1 } [\l_xtxko_rem_tl] {#3}
    \l_xetexko_pacify_bfseries
    \tl_put_right:cV { XK@newfont@family \token_to_str:N #1 } \l_xtxko_font_opts_tl
    \DeclareRobustCommand #1
      {
        \cs_set_nopar:Npn \XKhanjafont
          {
            \XK@storeltnfont
            \cs_set_eq:NN \XKcurrentfont \c__xtxko_two_int
            \use:c { XK@newfont@family \token_to_str:N #1 }
            \XK@storecjkfont
          }
      }
  }
\DeclareDocumentCommand \newhangulfontface { m O{} m O{} }
  {
    \__xtxko_hangul_assign_font_opts:n {#2,#4}
    \exp_args:Nc \newfontface { XK@newfont@family \token_to_str:N #1 } [\l_xtxko_rem_tl] {#3}
    \tl_put_right:cV { XK@newfont@family \token_to_str:N #1 } \l_xtxko_font_opts_tl
    \DeclareRobustCommand #1
      {
        \cs_set_nopar:Npn \XKhangulfont
          {
            \XK@storeltnfont
            \cs_set_eq:NN \XKcurrentfont \c__xtxko_one_int
            \use:c { XK@newfont@family \token_to_str:N #1 }
            \XK@storecjkfont
          }
      }
  }
\DeclareDocumentCommand \newhanjafontface { m O{} m O{} }
  {
    \__xtxko_hanja_assign_font_opts:n {#2,#4}
    \exp_args:Nc \newfontface { XK@newfont@family \token_to_str:N #1 } [\l_xtxko_rem_tl] {#3}
    \tl_put_right:cV { XK@newfont@family \token_to_str:N #1 } \l_xtxko_font_opts_tl
    \DeclareRobustCommand #1
      {
        \cs_set_nopar:Npn \XKhanjafont
          {
            \XK@storeltnfont
            \cs_set_eq:NN \XKcurrentfont \c__xtxko_two_int
            \use:c { XK@newfont@family \token_to_str:N #1 }
            \XK@storecjkfont
          }
      }
  }
%% add{hangul,hanja}fontfeature[s]
\cs_set_nopar:Npn \xetexkopacifybfseries {
  \cs_if_exist:cF { \f@encoding/\f@family/bx/\shapedefault }
    {
      \cs_gset_eq:cc
        { \f@encoding/\f@family/bx/\shapedefault }
        { \f@encoding/\f@family/\bfdefault/\shapedefault }
    }
  \cs_if_exist:cF { \f@encoding/\f@family/bx/\itdefault }
    {
      \cs_gset_eq:cc
        { \f@encoding/\f@family/bx/\itdefault }
        { \f@encoding/\f@family/\bfdefault/\itdefault }
    }
  \cs_if_exist:cF { \f@encoding/\f@family/bx/\sldefault }
    {
      \cs_gset_eq:cc
        { \f@encoding/\f@family/bx/\sldefault }
        { \f@encoding/\f@family/\bfdefault/\sldefault }
    }
  \cs_if_exist:cF { \f@encoding/\f@family/\mddefault/\updefault }
    {
      \cs_gset_eq:cc
        { \f@encoding/\f@family/\mddefault/\updefault }
        { \f@encoding/\f@family/\mddefault/\shapedefault }
    }
}
\DeclareDocumentCommand \addhangulfontfeature { m }
  {
    \group_begin:
    \XKhangulfont
    \tl_clear:N \l_xtxko_font_opts_tl
    \keys_set_known:nxN { xtxko-font } {#1} \l_xtxko_rem_tl
    \addfontfeature {\l_xtxko_rem_tl}
    \xetexkopacifybfseries
    \use:x
      {
        \group_end:
        \exp_not:N \cs_set_nopar:Npn \exp_not:N \XKhangulfont
          {
            \exp_not:V \XKhangulfont
            \exp_not:N \fontfamily { \f@family } \exp_not:N \selectfont
            \exp_not:V \l_xtxko_font_opts_tl
            \exp_not:N \XK@storecjkfont
          }
      }
    \ignorespaces
  }
\cs_set_eq:NN \addhangulfontfeatures \addhangulfontfeature
\DeclareDocumentCommand \addhanjafontfeature { m }
  {
    \group_begin:
    \XKhanjafont
    \tl_clear:N \l_xtxko_font_opts_tl
    \keys_set_known:nxN { xtxko-font } {#1} \l_xtxko_rem_tl
    \addfontfeature {\l_xtxko_rem_tl}
    \xetexkopacifybfseries
    \use:x
      {
        \group_end:
        \exp_not:N \cs_set_nopar:Npn \exp_not:N \XKhanjafont
          {
            \exp_not:V \XKhanjafont
            \exp_not:N \fontfamily { \f@family } \exp_not:N \selectfont
            \exp_not:V \l_xtxko_font_opts_tl
            \exp_not:N \XK@storecjkfont
          }
      }
    \ignorespaces
  }
\cs_set_eq:NN \addhanjafontfeatures \addhanjafontfeature
%% default font features
\defaultfontfeatures
  [
    \kormainfont, \korsansfont, \hnjmainfont, \hnjsansfont,
  ]
  {Ligatures=TeX}
\DeclareDocumentCommand \defaulthangulfontfeatures { t+ o m } % o is ignored
  {
    \IfBooleanTF {#1}
      {
        \tl_set_eq:NN \l_xtxko_font_opts_tl \l_xtxko_hangul_font_opts_init_tl
      }
      {
        \tl_set_eq:NN \l_xtxko_font_opts_tl \l_xtxko_font_opts_init_tl
      }
    \keys_set_known:nxN { xtxko-font } {#3} \l_xtxko_rem_tl % rem_tl ignored
    \tl_set_eq:NN \l_xtxko_hangul_font_opts_init_tl \l_xtxko_font_opts_tl
  }
\DeclareDocumentCommand \defaulthanjafontfeatures { t+ o m } % o is ignored
  {
    \IfBooleanTF {#1}
      {
        \tl_set_eq:NN \l_xtxko_font_opts_tl \l_xtxko_hanja_font_opts_init_tl
      }
      {
        \tl_set_eq:NN \l_xtxko_font_opts_tl \l_xtxko_font_opts_init_tl
      }
    \keys_set_known:nxN { xtxko-font } {#3} \l_xtxko_rem_tl % rem_tl ignored
    \tl_set_eq:NN \l_xtxko_hanja_font_opts_init_tl \l_xtxko_font_opts_tl
  }
%% math hangul font
\DeclareDocumentCommand \setmathhangulfont { O{} m O{} }
  {
    \fontspec_set_family:Nnn \xetexko@math@hangul@family {#1,#3} {#2}
    \l_xetexko_pacify_bfseries
  }
%%%%%%%%%%%%%%%%%%%%
%% xetexkofontregime
\keys_define:nn { xtxko-char }
  {
    alphs       .code:n = \use:c { #1alphs } ,
    nums        .code:n = \use:c { #1nums } ,
    parens      .code:n = \use:c { #1parens } ,
    quotes      .code:n = \use:c { #1quotes } ,
    puncts      .code:n = \use:c { #1puncts } ,
    colons      .code:n = \use:c { #1colons } ,
    hyphens     .code:n = \use:c { #1hyphens } ,
    cjksymbols  .code:n = \use:c { #1cjksymbols } ,
  }
\DeclareDocumentCommand \xetexkofontregime { O{} m O{} }
  {
    \use:c { #2marks }
    \keys_set:nn { xtxko-char } { #1,#3 }
  }
\ExplSyntaxOff

%%%%%%%%%%%%%%%%%%%%%%%%%%
% font switching for latex
\def\XKstoreprevfont{%
  \ifx\f@family\XKcjkprevfont\let\f@family\XKltnprevfont\fi
}
\def\XK@storeltnfont{%
  \ifx\f@family\XKcjkprevfont\else\let\XKltnprevfont\f@family\fi
}
\def\XK@storecjkfont{%
  \let\XKcjkprevfont\f@family
  \edef\XKplaincjkprevfont{\the\font}%
}
\edef\XKlatinfont{\unexpanded\expandafter{\XKstoreprevfont
    \chardef\XKcurrentfont\z@
    \edef\XK@plain@curr@font{\the\font}%
    \ifx\XK@plain@curr@font\XKplaincjkprevfont
      \selectfont
    \fi
}}

\def\XK@rm@korean@font{%
  \ifx\XKhangulfont\relax\else
    \def\XKhangulfont{%
      \XK@storeltnfont
      \chardef\XKcurrentfont\@ne\kormainfont
      \XK@storecjkfont
    }%
  \fi
  \ifx\XKhanjafont\relax\else
    \def\XKhanjafont {%
      \XK@storeltnfont
      \chardef\XKcurrentfont\tw@\hnjmainfont
      \XK@storecjkfont
    }%
  \fi
}
\def\XK@sf@korean@font{%
  \ifx\XKhangulfont\relax\else
    \def\XKhangulfont{%
      \XK@storeltnfont
      \chardef\XKcurrentfont\@ne\korsansfont
      \XK@storecjkfont
    }%
  \fi
  \ifx\XKhanjafont\relax\else
    \def\XKhanjafont {%
      \XK@storeltnfont
      \chardef\XKcurrentfont\tw@\hnjsansfont
      \XK@storecjkfont
    }%
  \fi
}
\def\XK@tt@korean@font{%
  \ifx\XKhangulfont\relax\else
    \def\XKhangulfont{%
      \XK@storeltnfont
      \chardef\XKcurrentfont\@ne\kormonofont
      \XK@storecjkfont
    }%
  \fi
  \ifx\XKhanjafont\relax\else
    \def\XKhanjafont {%
      \XK@storeltnfont
      \chardef\XKcurrentfont\tw@\hnjmonofont
      \XK@storecjkfont
    }%
  \fi
}

% using latex 2020's font family hooks
\edef\@rmfamilyhook{\unexpanded\expandafter{\@rmfamilyhook
  \XK@rm@korean@font}}
\edef\@sffamilyhook{\unexpanded\expandafter{\@sffamilyhook
  \XK@sf@korean@font}}
\edef\@ttfamilyhook{\unexpanded\expandafter{\@ttfamilyhook
  \XK@tt@korean@font\disablehangulspacing }}

\edef\verbatim@font{\unexpanded\expandafter{\verbatim@font
    \disablehangulspacingandlinebreak
    \let\XKstoreprevfont\XKlatinfont
}}

% for default font loading
\def\XKiffontisaccessible#1#2#3{%
  \begingroup
  \suppressfontnotfounderror\@ne
  \font\x="#1" at 10pt
  \expandafter
  \endgroup
  \ifx\x\nullfont #3\else #2\fi
}
\def\XKiffonthasunichar#1#2#3#4{%
  \begingroup #1\expandafter\endgroup
  \iffontchar\font"#2\relax #3\else #4\fi
}

\AtBeginDocument{%
  %%%%%%%%%%%%%%%%%%%%%%%%%%
  % default main hangul: nanummyeongjo, unbatang if absent
  \ifdefined\kormainfont\else
    \XKiffonthasunichar{\fontfamily\rmdefault\selectfont}{AC00}
      {\let\kormainfont\relax}
      {\XKiffontisaccessible{NanumMyeongjoExtraBold}
        {\setmainhangulfont{NanumMyeongjo}[Renderer=OpenType,BoldFont=*ExtraBold]}
        {\XKiffontisaccessible{NanumMyeongjo}
          {\setmainhangulfont{NanumMyeongjo}[Renderer=OpenType]}
          {\XKiffontisaccessible{[UnBatang]}
            {\setmainhangulfont{UnBatang.ttf}[BoldFont=UnBatangBold.ttf]}
            {\let\kormainfont\relax}%
          }%
        }%
      }%
  \fi
  % default main hanja: nanumgothic, unbatang if absent
  \ifdefined\hnjmainfont\else
    \XKiffonthasunichar{\kormainfont}{4E00}
      {\let\hnjmainfont\kormainfont}
      {\XKiffontisaccessible{NanumGothic}
        {\setmainhanjafont{NanumGothic}[Renderer=OpenType]}
        {\XKiffontisaccessible{[UnBatang]}
          {\setmainhanjafont{UnBatang.ttf}[BoldFont=UnBatangBold.ttf]}
          {\let\hnjmainfont\kormainfont}%
        }%
      }%
  \fi
  % default sans hangul: nanumgothic, undotum if absent
  \ifdefined\korsansfont\else
    \XKiffonthasunichar{\fontfamily\sfdefault\selectfont}{AC00}
      {\let\korsansfont\relax}
      {\XKiffontisaccessible{NanumGothic}
        {\setsanshangulfont{NanumGothic}[Renderer=OpenType]}
        {\XKiffontisaccessible{[UnDotum]}
          {\setsanshangulfont{UnDotum.ttf}[BoldFont=UnDotumBold.ttf]}
          {\let\korsansfont\relax}%
        }%
      }%
  \fi
  % default sans hanja: nanumgothic, undotum if absent
  \ifdefined\hnjsansfont\else
    \XKiffonthasunichar{\korsansfont}{4E00}
      {\let\hnjsansfont\korsansfont}
      {\XKiffontisaccessible{NanumGothic}
        {\setsanshanjafont{NanumGothic}[Renderer=OpenType]}
        {\XKiffontisaccessible{[UnDotum]}
          {\setsanshanjafont{UnDotum.ttf}[BoldFont=UnDotumBold.ttf]}
          {\let\hnjsansfont\korsansfont}%
        }%
      }%
  \fi
  \ifdefined\kormonofont\else \let\kormonofont\korsansfont \fi
  \ifdefined\hnjmonofont\else \let\hnjmonofont\kormonofont \fi
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% reset hangul font and normalfont
\expandafter\ifx\familydefault\rmdefault
  \XK@rm@korean@font
  \protected\edef\normalfont{\unexpanded\expandafter{\normalfont
    \XK@rm@korean@font}}
\else \expandafter\ifx\familydefault\sfdefault
  \XK@sf@korean@font
  \protected\edef\normalfont{\unexpanded\expandafter{\normalfont
    \XK@sf@korean@font}}
\else
  \XK@tt@korean@font
  \protected\edef\normalfont{\unexpanded\expandafter{\normalfont
    \XK@tt@korean@font}}
\fi\fi
\let\reset@font\normalfont
  %%%%%%%%%%%%%%%%%%%%%
  % hangul in math mode
  \begingroup
    \ifx\xetexko@math@hangul@family\undefined
      \edef\@tempb{\sfdefault}\edef\@tempc{\ttdefault}%
      \ifx\f@family\@tempb \korsansfont \else
      \ifx\f@family\@tempc \kormonofont \else
      \kormainfont \fi\fi
      \xdef\xetexko@math@hangul@family{\f@family}\fi
  \endgroup
  \DeclareSymbolFont{mathhangul}\f@encoding\xetexko@math@hangul@family
    \mddefault\updefault
  \ifcsname \f@encoding/\xetexko@math@hangul@family/\bfdefault/\updefault\endcsname
    \SetSymbolFont{mathhangul}{bold}\f@encoding\xetexko@math@hangul@family
      \bfdefault\updefault
  \fi
  \setmathhangulblock{AC00}{D7A3}
}

%%%%%%%%%%%%%%%%%%%%%%%
% under [hangul] option
\if@hangul
  \linespread{1.3888}
  \footnotesep=1.3888\footnotesep
  \skip\footins=\glueexpr\skip\footins/72*100\relax
  % frenchspacing is default
  \frenchspacing
\fi

\endinput
